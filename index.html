<html>
<head>
    <!-- aframe itself -->
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
    <!-- physics and other extras -->
<!--     <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>

 -->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>

    <script src="./dist/aframe-super-shooter-kit.min.js"></script>
    <script>
        $ = (sel) => document.querySelector(sel)
        $$ = (sel) => document.querySelectorAll(sel)
        on = (elem, type, hand) => elem.addEventListener(type,hand)
    </script>
    <!-- alternate random number generator -->
    <script src="js/random.js"></script>
    <!-- our `distribute` component -->
    <script>
        var GameManagerUtils = (function(){
            var score = 0;
            return{
                addScore: function(){
                    score+=1;
                },
                getScore: function(){
                    return score;
                },
                generateRandomNumber: function (min, max) {
                return Math.floor(Math.random() * max + min);
                },
                createEnemy: function () {
                    var newEnemy = document.createElement('a-entity');
                    newEnemy.setAttribute('gltf-model', '#imp');
                    newEnemy.setAttribute('position', '0 0 -5');
                    newEnemy.setAttribute('dynamic-body', 'shape:auto; mass:5');
                    newEnemy.setAttribute('id', 'enemy');
                    newEnemy.setAttribute('sound', 'src: url(./audio/gah.mp3); autoplay: false; loop: false;');
                    newEnemy.setAttribute('target', 'healthPoints: 1; static: false');
                    newEnemy.setAttribute('enemy', '')
                    return newEnemy;
                  }
            }
        })()
        AFRAME.registerComponent('game-manager', {
          init: function () {
            var sceneEl = this.el;
            var enemy = GameManagerUtils.createEnemy();
            sceneEl.addEventListener('loaded', function () {
              sceneEl.appendChild(enemy);
            });
            sceneEl.addEventListener('targetDestroyed', function(e) {
                console.log("targetDestroyed")
                setTimeout(
                    ()=>{this.appendChild(GameManagerUtils.createEnemy())}, 
                    GameManagerUtils.generateRandomNumber(3000, 6000));
            });
          }
        });
        /**
         * Press S to shoot.
         */
        AFRAME.registerComponent('click-to-shoot', {
          init: function () {
            document.body.addEventListener('keydown', (e) => { 
                if(e.keyCode == 83)
                    this.el.emit('shoot'); 
            });
          }
        });
        /**
         * Enemy
         */
        AFRAME.registerComponent('enemy', {

            init: function () {
                this.el.addEventListener('die', this.die.bind(this));
                this.el.addEventListener('body-loaded', this.jumpAndRun.bind(this))
                this.v_x = GameManagerUtils.generateRandomNumber(-GameManagerUtils.getScore()-1, GameManagerUtils.getScore()+1)
                this.v_y = 0;
                this.v_z = GameManagerUtils.generateRandomNumber(-GameManagerUtils.getScore()-1, GameManagerUtils.getScore()+1)
            },
            jumpAndRun: function(){
                this.jump();
                setTimeout(()=>{this.run()}, 2000)
            },
            die:function(){
                console.log("die")

                this.jump();
                this.hide();
                this.el.emit("targetDestroyed")
                // Add 1 to Score
                GameManagerUtils.addScore();
                $("#score").setAttribute('text','value','Score '+GameManagerUtils.getScore())

            },
            /*
            ** Jump Animation
            */
            jump: function(){
                console.log("jump")
                this.el.setAttribute('dynamic-body', 'mass:5')
                
                var force = new CANNON.Vec3(this.v_x, 20, this.v_z)
                var local = new CANNON.Vec3(0,0,0)
                this.el.body.applyLocalImpulse(force, local);
                
                // Play sound
                $("#enemy").components.sound.playSound();
            },
            hide: function(){
                console.log('hide')
                this.el.object3D.position.set(0, 0, -4);
                this.el.setAttribute('velocity', '0 0 0')
                this.el.components['dynamic-body'].syncToPhysics()
                this.el.setAttribute('dynamic-body', 'mass:5')

                setTimeout(() => {
                  this.jumpAndRun();
                }, GameManagerUtils.generateRandomNumber(3000, 6000));

            },
            run: function(){
                console.log("run")
                
                var velocity = this.v_x+' '+this.v_y+' '+this.v_z;
                this.el.setAttribute('dynamic-body', 'mass:0')
                this.el.setAttribute('velocity', velocity)
                console.log($("#enemy").getAttribute('velocity'))
            }

        });
        AFRAME.registerComponent('distribute', {
            schema: {
                src: {type:'string'},
                jitter: {type:'vec3'},
                modelCenter: {type:'vec3'},
                radius: {type:'number'}
            },
            init: function() {
                const rg = new Random(Random.engines.mt19937().seed(10))
                const center = new THREE.Vector3(this.data.modelCenter.x, this.data.modelCenter.y, this.data.modelCenter.z)
                const jx = this.data.jitter.x
                const jy = this.data.jitter.y
                const jz = this.data.jitter.z
                if($(this.data.src).hasLoaded) {
                    const s = this.data.radius
                    for(let i = -s; i<s; i++) {
                        for(let j=-s; j<s; j++) {
                            const el = document.createElement('a-entity')
                            el.setAttribute('gltf-model', this.data.src)
                            const offset = new THREE.Vector3(i*s + rg.real(-jx,jx), rg.real(-jy,jy), j*s - rg.real(-jz,jz));
                            el.setAttribute('position', center.clone().add(offset));
                            el.setAttribute('rotation',{x:0, y:rg.real(-45,45)*Math.PI/180, z:0})
                            const scale = rg.real(0.5,1.5)
                            el.setAttribute('scale',{x:scale,y:scale,z:scale})
                            $('a-scene').appendChild(el)
                        }
                    }
                }
            }
        })
    </script>

</head>
<body>
<a-scene
        physics="debug:false;"
        sound="src: url(./audio/octobernight2.mp3); loop:true; autoplay:true; volume:0.5;"
        game-manager
>
    <a-assets>
        <a-asset-item id="imp" src="models/imp/scene.gltf"></a-asset-item>
        <a-asset-item id="tree1" src="models/arbol1/scene.gltf"></a-asset-item>
        <a-asset-item id="tree2" src="models/arbol2/scene.gltf"></a-asset-item>
        <a-asset-item id="moon" src="models/moon/scene.gltf"></a-asset-item>
        <a-asset-item id="cauldron" src="models/cauldron/scene.gltf"></a-asset-item>
        <a-asset-item id="rock1" src="models/rock1/scene.gltf"></a-asset-item>
    </a-assets>

    <a-entity id="bulletTemplate" bullet geometry="primitive: sphere; radius: 0.1" material="color: orange"></a-entity>

    <a-entity camera look-controls position="0 1.5 0" shooter click-to-shoot>
        <a-text id="score" value="Score" position="-1 -0.6 -1" color="white" width="3" anchor="left"></a-text>
        <a-entity cursor="fuse: true; fuseTimeout: 500"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: red; shader: flat">
        </a-entity>
    </a-entity>
    

<!--     <a-entity id='enemy' gltf-model="#imp"
                  position="0 0 -4"
                  dynamic-body="shape:auto"
                  sound="src: url(./audio/gah.mp3); autoplay: false; loop: false;" 
                  target="healthPoints: 1; static: false"
                  enemy></a-entity> -->

    <!-- the ground --->
    <a-plane color="#52430e"
             static-body
             rotation="-90 0 0" width="100" height="100"  shadow="receive:true"></a-plane>


    <!-- cauldron -->
    <a-entity  position="1.5 0 -3.5" gltf-model="#cauldron"
               sound="src: url(./audio/boilingwater-loop.mp3); autoplay: true; loop:true;"
               animation-mixer></a-entity>

    <!-- the moon -->
    <a-entity gltf-model="#moon"></a-entity>

    <!-- trees -->
    <a-entity gltf-model="#tree2" position="38 8.5 -10"></a-entity>
    <a-entity gltf-model="#tree1" position="33 5.5 -10"></a-entity>
    <a-entity gltf-model="#tree1" position="33 5.5 -30"></a-entity>

    <!-- rocks -->
    <a-entity distribute="jitter: 2 0.5 2; modelCenter: 59 -0.8 32; src:#rock1; radius:3"></a-entity>


    <!-- background sky -->
    <a-sky color="#270d2c"></a-sky>
    <!-- hemisphere light going from white to dark blue -->
    <a-entity light="type: hemisphere; color: white; groundColor: #5424ff; intensity: 0.4"></a-entity>
    <!-- firelight -->
    <a-entity light="type: point; intensity: 1.6; distance: 5; decay: 2; color: red" position="0.275 -0.32 -3.77"></a-entity>
    <!-- directional moon light -->
    <a-entity light="type: directional; color: #ffffff; intensity: 0.5; castShadow:true;"
              position="31 80 -50"></a-entity>


</a-scene>
<!-- <script type="text/javascript">
    var el = document.querySelector('#box');
    console.log(el)
    el.body.applyImpulse(
      /* impulse */        new CANNON.Vec3(0, 1, -1),
      /* world position */ new CANNON.Vec3().copy(el.getComputedAttribute('position'))
    );
</script> -->
</body>
</html>

